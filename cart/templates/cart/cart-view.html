{% extends "base.html" %} 
{% load static %} 
{% load mathfilters %} 
{% block content %}


  <div class="container  mt-4">
    {% if cart|length == 0 %}
      <h2 class="text-secondary">Корзина пуста.</h2>
      <hr />
    {% else %}
  <div class="card border-info">
    <div class="card-header bg-info text-white">
      <h3 class="mb-0"><i class="fas fa-shopping-cart"></i>  Корзина</h3>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-bordered text-secondary">
        <thead>
          <tr>
            <th>Продукт</th>
            <th>Цена</th>
            <th>Количество</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for item in cart %}
          {% with product=item.product %}
          <tr>
            <td>{{ product.name }}</td>
            <td>{{ product.price|mul:item.qty|floatformat:2 }}</td>
            <td>
              <select id="select{{ product.id }}" class="custom-select">
                <option value="1" {% if item.qty == 1 %} selected {% endif %}>1</option>
                <option value="2" {% if item.qty == 2 %} selected {% endif %}>2</option>
                <option value="3" {% if item.qty == 3 %} selected {% endif %}>3</option>
                <option value="4" {% if item.qty == 4 %} selected {% endif %}>4</option>
            </select>
            </td>
            <td>
              <button type="button" data-index="{{ product.id }}" class="btn btn-primary btn-sm update-button" title="Обновить">
                  <i class="fa fa-edit" aria-hidden="true"></i>
              </button>
              <button type="button" class="btn btn-danger btn-sm delete-button" data-index="{{ product.id }}" title="Удалить">
                  <i class="fa fa-trash" aria-hidden="true"></i>
              </button>
            </td>
          
          </tr>
          {% endwith %}
          {% endfor %}
        </tbody>
      </table>

      <div class="text-end">
        <h6 class="text-secondary">Итого: <span id="total" class="font-weight-bold">{{ cart.get_total_price|floatformat:2 }} ₽</span></h6>
        <a href="{% url 'orders:create_order' %}" class="btn btn-info btn-md mt-4">Оформить заказ</a>   
      </div>
    </div>
  </div>
    {% endif %}
  </div>
</div>


<script>
  $(document).on('click', '.delete-button', function(e) {
    e.preventDefault();

    $.ajax({
      type: 'POST',
      url: '{% url "cart:delete-to-cart" %}',
      data: {
        product_id: $(this).data('index'),
        csrfmiddlewaretoken: '{{ csrf_token }}',
        action: 'post'
      },
      success: function(response) {
        document.getElementById('lblCartCount').textContent = response.qty;
        document.getElementById('total').textContent = response.total;

        location.reload();
      },
      error: function(error, status) {
        console.log(error);
      }
    });
  });

  $(document).on('click', '.update-button', function(e) {
    e.preventDefault();

    var product_id = $(this).data('index');

    $.ajax({
      type: 'POST',
      url: '{% url "cart:update-to-cart" %}',
      data: {
        product_id: product_id,
        product_qty: $('#select' + product_id + ' option:selected').val(),
        csrfmiddlewaretoken: '{{ csrf_token }}',
        action: 'post'
      },
      success: function(response) {
        document.getElementById('lblCartCount').textContent = response.qty;
        document.getElementById('total').textContent = response.total;

        location.reload();
      },
      error: function(error, status) {
        console.log(error);
      }
    });
  });
</script>

{% endblock %}
