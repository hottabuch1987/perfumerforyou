{% extends "base.html" %}
{% load static %}
{% block content %}

<div class="container mt-4">
    
    {% if products %}
    <div class="card border-info">
        <div class="card-header bg-info text-white">
            <h3 class="mb-0"><i class="fas fa-box"></i> Все товары</h3>
        </div>
        
        <div class="card-body">
            <div class="table-responsive">
                <p class="text-secondary">Всего товаров: {{ products|length }}</p>
                <form method="get" action="{% url 'products:list' %}" class="mb-3">
                    <div class="row g-3">
                        <div class="col-sm-12 col-md-4">
                            <input type="text" name="name_query" value="{{ name_query|default:'' }}" placeholder="Поиск по имени" class="form-control m-2" />
                        </div>
                        <div class="col-sm-12 col-md-4">
                            <input type="text" name="price_query" value="{{ price_query|default:'' }}" placeholder="Поиск по цене" class="form-control m-2" />
                        </div>
                        <div class="col-sm-12 col-md-4">
                            <button type="submit" class="btn btn-info w-30 m-2">Поиск</button>
                        </div>
                    </div>
                </form>
                
                <table class="table table-bordered table-hove text-secondary">
                    <thead>
                        <tr>
                            <th>Название</th>
                            <th>Цена</th>
                            
                            <th>Артикул</th>
                            <th>Время обновления</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products %}
                            <tr>
                                <td>{{ product.name }}</td>
                                <td>
                                {{ product.display_final_price|floatformat:2 }} 
                                {% if request.GET.currency == 'USD' %}USD{% else %}₽{% endif %}
                                </td>
                               
                                <td>{{ product.article}}</td>
                                <td>{{ product.updated_at }}</td>
                          
                                

                                <td>
                                    <button type="button" 
                                            class="btn btn-info btn-sm add-button" 
                                            data-product-id="{{ product.id }}"
                                            {% if product.quantity < 1 %}disabled{% endif %}>
                                        Добавить в <i class="fa fa-shopping-cart"></i>
                                    </button>
                                    {% if product.quantity < 1 %}
                                    <small class="text-danger d-block">Нет в наличии</small>
                                    {% endif %}
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">Нет доступных товаров.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            
        {% else %}
                <h2 class="text-secondary">Товары не найдены.</h2>
                <form method="get" action="{% url 'products:list' %}" class="mb-3">
                    <div class="row g-3">
                        <div class="col-sm-12 col-md-4">
                            <input type="text" name="name_query" value="" placeholder="Поиск по имени" class="form-control" />
                        </div>
                        <div class="col-sm-12 col-md-4">
                            <input type="text" name="price_query" value="" placeholder="Поиск по цене" class="form-control" />
                        </div>
                        <div class="col-sm-12 col-md-4">
                            <button type="submit" class="btn btn-info w-30">Поиск</button>
                        </div>
                    </div>
                </form>
        {% endif %}
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Обработчик для кнопок добавления
        document.querySelectorAll('.add-button').forEach(button => {
            button.addEventListener('click', function(e) {
                const productId = this.dataset.productId;
                const url = "{% url 'cart:add_to_cart' 0 %}".replace('0', productId);
                
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Товар добавлен в корзину', 'success');
                        updateCartCounter(data.total_items);
                    } else {
                        showToast(data.error || 'Ошибка добавления', 'danger');
                    }
                })
                .catch(error => {
                    showToast('Ошибка сети', 'danger');
                });
            });
        });
    
        // Функция для показа уведомлений
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast alert alert-${type} fixed-top mx-auto mt-3`;
            toast.innerHTML = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }
    
        // Функция обновления счетчика корзины
        function updateCartCounter(totalItems) {
            const counter = document.getElementById('cart-counter');
            if (counter) {
                counter.textContent = totalItems;
                counter.classList.remove('d-none');
            }
        }
    });
    </script>
{% endblock %}